<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
  <style>
body {
  margin: 0;
  font-family: 'Arial', sans-serif;
  background-color: #e0f7fa;
  overflow: hidden;
}

#startScreen {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background-color: #ffffff;
  z-index: 10000;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  text-align: center;
  padding: 20px;
}

#startScreen h1 { font-size: 40px; margin-bottom: 20px; color: #00796b; }
#startScreen p { font-size: 20px; margin: 10px 0; color: #555; }
#startBtn {
  margin-top: 30px; font-size: 24px; padding: 12px 30px;
  background-color: #00796b; color: white; border: none;
  border-radius: 8px; cursor: pointer; transition: background-color 0.3s;
}
#startBtn:hover { background-color: #004d40; }

#cat { position: absolute; display: none; }
#cat img { width: 80px; }

.paw { position: absolute; z-index: 1000; }
.paw img { width: 30px; }

.target {
  position: absolute; top: 0px;
  width: 100px; height: 50px; text-align: center; line-height: 50px;
}
.target img { width: 60px; }

.fish img { width: 60px; }

#gameover {
  display: none; position: fixed; top: 0; left: 0;
  width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.85);
  color: white; font-size: 28px; text-align: center; padding-top: 60px;
  z-index: 9999;
}
#retry {
  margin-top: 20px; padding: 10px 20px; font-size: 24px;
  cursor: pointer; background-color: #ffffff; color: #00796b;
  border: none; border-radius: 6px;
}

#hud {
  display: none; position: fixed; top: 20px; right: 20px;
  background-color: white; padding: 16px 24px; border-radius: 12px;
  box-shadow: 0 0 10px rgba(0,0,0,0.2);
  z-index: 5000; font-size: 20px; color: #333; font-weight: bold;
}
#hud span { color: #00796b; font-size: 22px; }

#timer { margin-top: 10px; font-size: 18px; color: #00796b; }
#ranking { margin-top: 20px; font-size: 20px; }

/* ===== スマホ操作用UI ===== */
#controls {
  position: fixed;
  bottom: 10px;
  width: 100%;
  z-index: 6000;
  display: flex;
  justify-content: space-between;
  pointer-events: none; /* UI以外クリック可能にする */
}

#fireBtn {
  pointer-events: auto;
  background: #ff7043;
  color: white;
  border: none;
  border-radius: 50%;
  width: 80px;
  height: 80px;
  font-size: 18px;
  margin-left: 20px;
}

#moveBtns {
  pointer-events: auto;
  margin-right: 20px;
  display: grid;
  grid-template-columns: 60px 60px 60px;
  grid-template-rows: 60px 60px 60px;
  gap: 5px;
}
#moveBtns button {
  background: #00796b;
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 18px;
}
#up { grid-column: 2; grid-row: 1; }
#left { grid-column: 1; grid-row: 2; }
#down { grid-column: 2; grid-row: 2; }
#right { grid-column: 3; grid-row: 2; }
  </style>
</head>
<body>

<div id="startScreen">
  <h1>ネコのシューティングゲーム</h1>
  <p>30秒以内にスコアを稼ごう！</p>
  <p>ネズミを倒すと +100点、ネズミに当たると HP -100</p>
  <p>魚を取ると HP +50</p>
  <p>←↑→↓で移動、スペースで肉球発射</p>
  <button id="startBtn">ゲームスタート</button>
</div>

<div id="hud">
  HP: <span id="number">1000</span><br>
  得点: <span id="count">0</span>
  <div id="timer">残り時間: 30</div>
</div>

<div id="cat"><img src="cat.png"></div>

<div id="gameover">
  <div id="finalScore"></div>
  <div id="ranking"></div>
  <button id="retry">再挑戦</button>
</div>

<!-- ===== スマホ用UI ===== -->
<div id="controls">
  <button id="fireBtn">発射</button>
  <div id="moveBtns">
    <button id="up">↑</button>
    <button id="left">←</button>
    <button id="down">↓</button>
    <button id="right">→</button>
  </div>
</div>

<script>
let score = 0;
let hp = 1000;
let fallDuration = 4000;
let difficultyTimer;
let moveStep = 20;
let isGameOver = false;
let gameStarted = false;
let timeLimit = 30;   // 秒
let timerInterval;

function startGame() {
  $("#startScreen").fadeOut(500);
  $("#cat").show();
  $("#hud").show();
  gameStarted = true;
  isGameOver = false;
  score = 0;
  hp = 1000;
  $("#count").text(score);
  $("#number").text(hp);

  let windowWidth = $(window).width();
  let windowHeight = $(window).height();
  let catWidth = $("#cat").width();
  let catHeight = $("#cat").height();
  $("#cat").css({
    left: (windowWidth - catWidth) / 2 + "px",
    top: (windowHeight - catHeight) / 2 + "px"
  });

  difficultyTimer = setInterval(() => {
    if (fallDuration > 1000) fallDuration -= 300;
  }, 8000);

  let remaining = timeLimit;
  $("#timer").text("残り時間: " + remaining);
  timerInterval = setInterval(() => {
    remaining--;
    $("#timer").text("残り時間: " + remaining);
    if (remaining <= 0) endGame();
  }, 1000);
}

function endGame() {
  if (isGameOver) return;
  isGameOver = true;
  gameStarted = false;
  clearInterval(difficultyTimer);
  clearInterval(timerInterval);
  $("#cat").hide();
  $("#hud").hide();

  let scores = JSON.parse(localStorage.getItem("catGameScores") || "[]");
  scores.push(score);
  localStorage.setItem("catGameScores", JSON.stringify(scores));
  scores.sort((a,b)=>b-a);
  let rank = scores.indexOf(score) + 1;
  let topList = scores.slice(0,5).map((s,i)=>`${i+1}位: ${s}`).join("<br>");

  $("#finalScore").html(`ゲーム終了！<br>あなたのスコア: <strong>${score}</strong><br>あなたの順位: <strong>${rank}位</strong>`);
  $("#ranking").html("<br>🏆 ランキング 🏆<br>" + topList);
  $("#gameover").fadeIn(500);
}

$("#startBtn").on("click", startGame);
$("#retry").on("click", () => location.reload());

function createMouse() {
  if (!gameStarted || isGameOver) return;
  const mouse = $("<div class='target'><img src='mouce.png'></div>");
  const left = Math.random() * ($(window).width() - 100);
  mouse.css({ left: left + "px", top: "0px" });
  $("body").append(mouse);
  mouse.animate({
    top: ($(window).height() - 50) + "px"
  }, fallDuration, function () {
    $(this).fadeOut(500, function () { $(this).remove(); });
  });
}
setInterval(createMouse, 500);

function createFish() {
  if (!gameStarted || isGameOver) return;
  const fish = $("<div class='fish'><img src='fish.png'></div>");
  const left = Math.random() * ($(window).width() - 100);
  fish.css({ left: left + "px", top: "0px", position: "absolute" });
  $("body").append(fish);
  fish.animate({
    top: ($(window).height() - 50) + "px"
  }, fallDuration + 1000, function () {
    $(this).fadeOut(500, function () { $(this).remove(); });
  });
}
setInterval(()=>{ if (Math.random()<0.1) createFish(); },1500);

$(document).keydown(function (e) {
  if (!gameStarted) return;
  moveCat(e.keyCode);
});

function moveCat(keyCode){
  let cat = $("#cat");
  let position = cat.position();
  let catWidth = cat.width();
  let catHeight = cat.height();
  let windowWidth = $(window).width();
  let windowHeight = $(window).height();
  switch (keyCode) {
    case 37: if (position.left > 0) cat.css("left", Math.max(0, position.left - moveStep)); break;
    case 38: if (position.top > 0) cat.css("top", Math.max(0, position.top - moveStep)); break;
    case 39: if (position.left + catWidth < windowWidth) cat.css("left", Math.min(windowWidth - catWidth, position.left + moveStep)); break;
    case 40: if (position.top + catHeight < windowHeight) cat.css("top", Math.min(windowHeight - catHeight, position.top + moveStep)); break;
    case 32: firePaw(); break;
  }
}

// ===== スマホボタン操作（長押し対応） =====
function holdButton(selector, keyCode) {
  let interval;
  $(selector).on("mousedown touchstart", function(e){
    e.preventDefault();
    moveCat(keyCode);
    interval = setInterval(()=>moveCat(keyCode), 100);
  });
  $(selector).on("mouseup mouseleave touchend", function(){
    clearInterval(interval);
  });
}
holdButton("#up", 38);
holdButton("#down", 40);
holdButton("#left", 37);
holdButton("#right", 39);

// 発射ボタン長押し（ゆっくり連射: 300ms間隔）
function holdFireButton(selector) {
  let interval;
  $(selector).on("mousedown touchstart", function(e){
    e.preventDefault();
    if(gameStarted) firePaw();
    interval = setInterval(()=>{ if(gameStarted) firePaw(); }, 300);
  });
  $(selector).on("mouseup mouseleave touchend", function(){
    clearInterval(interval);
  });
}
holdFireButton("#fireBtn");

function firePaw() {
  if (isGameOver) return;
  const cat = $("#cat");
  const catOffset = cat.offset();
  const catCenterX = catOffset.left + cat.width() / 2;
  const paw = $("<div class='paw'><img src='hand.png'></div>");
  paw.css({ left: catCenterX - 15 + "px", top: catOffset.top - 20 + "px" });
  $("body").append(paw);

  function movePaw() {
    if (isGameOver) { paw.remove(); return; }
    let pawTop = paw.position().top;
    paw.css("top", pawTop - 10 + "px");
    $(".target").each(function () {
      if (isColliding(paw, $(this))) {
        $(this).stop().fadeOut(200, function () { $(this).remove(); });
        paw.remove();
        score += 100;
        $("#count").html(score);
      }
    });
    $(".fish").each(function () {
      if (isColliding(paw, $(this))) {
        $(this).stop().fadeOut(200, function () { $(this).remove(); });
        paw.remove();
        hp = Math.min(1000, hp + 50);
        $("#number").text(hp);
      }
    });
    if (paw.position().top < -30) { paw.remove(); return; }
    requestAnimationFrame(movePaw);
  }
  movePaw();
}

function isColliding(a,b){
  let aOffset=a.offset(), bOffset=b.offset();
  return !(
    aOffset.top + a.height() < bOffset.top ||
    aOffset.top > bOffset.top + b.height() ||
    aOffset.left + a.width() < bOffset.left ||
    aOffset.left > bOffset.left + b.width()
  );
}

function updateHP(dmg){
  if (isGameOver) return;
  hp -= dmg;
  if (hp < 0) hp = 0;
  $("#number").text(hp);
  if (hp <= 0) endGame();
}

setInterval(function(){
  if (!gameStarted || isGameOver) return;
  $(".target").each(function(){
    if (!$(this).data("hit") && isColliding($("#cat"), $(this))) {
      $(this).data("hit", true);
      $("#cat img").attr("src","odoroki.png");
      setTimeout(()=>$("#cat img").attr("src","cat.png"),500);
      updateHP(100);
      $(this).stop().fadeOut(200,function(){ $(this).remove(); });
    }
  });
  $(".fish").each(function(){
    if (!$(this).data("hit") && isColliding($("#cat"), $(this))) {
      $(this).data("hit", true);
      hp = Math.min(1000, hp + 50);
      $("#number").text(hp);
      $(this).stop().fadeOut(200,function(){ $(this).remove(); });
    }
  });
},100);
</script>
</body>
</html>
